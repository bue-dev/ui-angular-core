<!--
  Copyright (C) 2018-present evan GmbH.

  This program is free software: you can redistribute it and/or modify it
  under the terms of the GNU Affero General Public License, version 3,
  as published by the Free Software Foundation.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program. If not, see http://www.gnu.org/licenses/ or
  write to the Free Software Foundation, Inc., 51 Franklin Street,
  Fifth Floor, Boston, MA, 02110-1301 USA, or download the license from
  the following URL: https://evan.network/license/

  You can be released from the requirements of the GNU Affero General Public
  License by purchasing a commercial license.
  Buying such a license is mandatory as soon as you use this software or parts
  of it on other blockchains than evan.network.

  For more information, please contact evan GmbH at this address:
  https://evan.network/license/
-->

<!----------------------------------- claim user alias--------------------------------------------->
<ng-template #userAlias let-address="address">
  <ng-container *ngIf="address">
    <ng-container *ngIf="address === claimService.ensRootOwner">
      evan ({{ claimService.ensRootOwner }})
    </ng-container>
    <ng-container *ngIf="address !== claimService.ensRootOwner">
      {{ (addressbook[address]?.alias || addressbook[address]?.email) ? (addressbook[address]?.alias || addressbook[address]?.email) + ' (' + address + ')' : address }}
    </ng-container>
  </ng-container>
</ng-template>

<!----------------------------- claim alias multiline --------------------------------------------->
<ng-template #userAliasMulti let-address="address">
  <ng-container *ngIf="address">
    <ng-container *ngIf="address === claimService.ensRootOwner">
      <b>evan</b>
      <p>{{ claimService.ensRootOwner }}</p>
    </ng-container>
    <ng-container *ngIf="address !== claimService.ensRootOwner">
      <b>
        {{ addressbook[address]?.alias || addressbook[address]?.email || ('_angularcore.no-alias' | translate) }}
      </b>
      <p>
        {{ address }}
      </p>
    </ng-container>
  </ng-container>
</ng-template>

<!---------------------------------------- claim icon --------------------------------------------->
<ng-template #claimIcon let-claim="claim" let-mode="mode">
  <div class="claim-icon">
    <ion-spinner *ngIf="loadingClaims"></ion-spinner>
    <ng-container *ngIf="!loadingClaims">
      <svg *ngIf="!claim.icon" version="1.0" xmlns="http://www.w3.org/2000/svg"
         width="512.000000pt" height="512.000000pt" viewBox="0 0 512.000000 512.000000"
         preserveAspectRatio="xMidYMid meet">
          <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" stroke="none">
          <path d="M2510 4994 c-135 -140 -432 -395 -635 -547 -502 -375 -990 -618
          -1444 -719 l-104 -23 7 -107 c14 -233 92 -597 192 -894 311 -930 933 -1793
          1784 -2475 164 -131 188 -149 198 -149 20 0 283 183 420 293 594 475 1057
          1046 1388 1712 233 468 377 929 453 1450 12 77 21 147 21 156 0 11 -34 29
          -112 58 -335 126 -816 354 -1103 522 -374 219 -660 429 -906 667 -59 56 -108
          102 -111 102 -2 0 -24 -21 -48 -46z m143 -406 c392 -340 1056 -731 1682 -988
          72 -30 133 -56 137 -59 9 -7 -39 -250 -82 -421 -141 -556 -410 -1114 -770
          -1595 -149 -199 -270 -337 -474 -540 -200 -200 -320 -306 -491 -434 -144 -108
          -115 -109 -248 2 -422 354 -786 755 -1063 1172 -301 452 -517 931 -632 1405
          -33 135 -74 361 -67 368 2 3 69 26 147 52 466 156 946 432 1439 826 63 51 163
          135 223 188 59 53 109 96 112 96 2 0 41 -32 87 -72z"/>
          <path d="M2555 4460 c-11 -17 -256 -219 -395 -324 -411 -312 -848 -557 -1240
          -697 l-105 -37 2 -45 c2 -66 66 -317 127 -501 258 -773 756 -1489 1469 -2114
          l118 -104 37 28 c209 159 518 451 698 659 421 487 719 1003 908 1577 53 162
          126 451 129 509 l2 41 -110 47 c-609 263 -1145 578 -1582 930 -29 24 -54 37
          -58 31z"/>
        </g>
      </svg>

      <img
        *ngIf="claim.icon"
        [src]="_DomSanitizer.bypassSecurityTrustUrl(claim.icon)">
    </ng-container>
  </div>
</ng-template>

<!---------------------------------------- claim display ------------------------------------------>
<ng-template #claimDisplay let-claim="claim" let-mode="mode" let-action="action">
  <div [class]="'evan-claim mode-' + mode + ' status-' + claim.status"
    (click)="action ? action($event) : openClaimPopup(claim, $event)">
    <ng-container *ngTemplateOutlet="claimIcon;context:{ claim: claim, mode: mode }"></ng-container>
    <ng-container *ngIf="!loadingClaims && mode != 'icon'">
      <div class="claim-label">
        <b *ngIf="!claim.creationDate">
          {{ claim.displayName }}
        </b>
        <div *ngIf="claim.creationDate">
          <b>{{ claim.displayName }}</b>
          <p>
            {{ claim.creationDate | date:'mediumDate':'':translate.translate.currentLang }}

            <ng-container *ngIf="claim.expirationDate">
              - {{ claim.expirationDate | date:'mediumDate':'':translate.translate.currentLang }}
            </ng-container>
          </p>
        </div>
      </div>

      <div class="claim-count" *ngIf="claim.claims && claim.claims.length > 1">
        {{ claim.claims.length }} <ion-icon name="people"></ion-icon>
        <ion-spinner *ngIf="claim.loading"></ion-spinner>
      </div>
    </ng-container>
  </div>
</ng-template>

<ng-template #claimInteraction let-interactionClaim="interactionClaim">
  <div class="claim-interaction"
    *ngIf="claimInteractionCount(interactionClaim) !== 0">
    <button ion-button icon-left round outline icon-only disabled
      *ngIf="interactionClaim.loading">
      <ion-spinner></ion-spinner>
    </button>

    <ng-container *ngIf="!interactionClaim.loading">
      <button ion-button icon-left round icon-only color="success"
        [title]="'_angularcore.claims.dispatcher.acceptDispatcher.title' | translate"
        *ngIf="canAcceptClaim(interactionClaim)"
        (click)="triggerDispatcher(interactionClaim, 'acceptDispatcher', $event)">
        <ion-icon name="checkmark"></ion-icon>
      </button>
      <button ion-button icon-left round icon-only
        [title]="'_angularcore.claims.issue-claim' | translate"
        *ngIf="canIssueClaim(interactionClaim)"
        (click)="openIssueClaim(interactionClaim, $event)">
        <ion-icon name="ribbon"></ion-icon>
      </button>
      <button ion-button icon-left round icon-only color="danger"
        [title]="'_angularcore.claims.dispatcher.deleteDispatcher.title' | translate"
        *ngIf="canDeleteClaim(interactionClaim)"
        (click)="triggerDispatcher(interactionClaim, 'deleteDispatcher', $event)">
        <ion-icon name="trash"></ion-icon>
      </button>
    </ng-container>
  </div>
</ng-template>

<!------------------------------------------ detailClaim ------------------------------------------>
<ng-template #claimDetailDisplay let-detailClaim="detailClaim">
  <!-- if claims array exists on the detailClaims, we are currently running an computed claim, so we
       cann show the first corresponding user -->
  <div class="claim-detail-row static-height"
    *ngIf="detailClaim.claims && detailClaim.topLevel">
    <div
      [class]="'claim-person status-' + detailClaim.status"
      (click)="activateSubClaim(detailClaim, null, $event)">
      <ion-icon name="person"></ion-icon>
      <div class="claim-person-label">
        <ng-container
          *ngTemplateOutlet="userAliasMulti;context:{ address: detailClaim.subject || detailClaim.subjects[0] }">
        </ng-container>
      </div>
      <div class="claim-person-detail only-interaction" *ngIf="canIssueClaim(detailClaim)">
        <ng-container
          *ngTemplateOutlet="claimInteraction;context:{ interactionClaim: detailClaim }">
        </ng-container>
      </div>
    </div>
  </div>

  <!-- display the detail claim batch -->
  <div class="claim-detail-row static-height">
    <div [class]="'claim-connector claim-row-connector active status-' + detailClaim.status">
      <ion-icon name="arrow-dropleft"></ion-icon>
      <div></div>
    </div>
    <ng-container
      *ngTemplateOutlet="claimDisplay;context:{ claim: detailClaim, mode: 'normal', action: activateSubClaim.bind(this, detailClaim, null) }">
    </ng-container>
  </div>

  <!-- display claims in case of a computed claim or parents, in case of a normal claim -->
  <div class="claim-detail-row static-width"
    [class.padding-left]="getClaimsOrParents(detailClaim).length > 1 && !detailClaim.activeSubClaim"
    [style.height]="detailClaim.subRowHeight + 'px'"
    *ngIf="getClaimsOrParents(detailClaim).length > 0">
    <div [class]="'claim-connector claim-row-connector ' + (detailClaim.activeSubClaim ? 'active' : '') + ' status-' + (detailClaim.activeSubClaim ? detailClaim.activeSubClaim.status : detailClaim.status)">
      <ion-icon name="arrow-dropleft"></ion-icon>
      <div></div>
    </div>

    <div class="claim-person"
      *ngFor="let subClaim of getClaimsOrParents(detailClaim); let i = index"
      [class]="'claim-person status-' + subClaim.status + (subClaim.active ? ' active' : '')"
      [style.top]="subClaim.topPos + 'px'">
      <div [class]="'claim-connector claim-people-connector ' + (subClaim.active ? 'active' : '') + ' status-' + subClaim.status"
        *ngIf="getClaimsOrParents(detailClaim).length > 1 && !subClaim.active">
        <div></div>
        <div *ngIf="getClaimsOrParents(detailClaim).length > 1 && !subClaim.active"
          [@slowGrowTransition]="{ value: ':enter', params : { height : subClaim.vertical.height + 'px' } }"
          [style.height]="subClaim.vertical.height + 'px'"
          [style.top]="subClaim.vertical.top ? subClaim.vertical.top + 'px' : ''"
          [style.bottom]="subClaim.vertical.bottom ? subClaim.vertical.bottom + 'px' : ''">
        </div>
      </div>
      <ion-icon name="person"></ion-icon>
      <div class="claim-person-label"
        *ngIf="subClaim.warnings.indexOf('missing') === -1"
        (click)="activateSubClaim(detailClaim, subClaim, $event)">
        <ng-container
          *ngTemplateOutlet="userAliasMulti;context:{ address: subClaim.issuerAccount }">
        </ng-container>
      </div>
      <div class="claim-person-label"
        *ngIf="subClaim.warnings.indexOf('missing') !== -1"
        (click)="activateSubClaim(detailClaim, subClaim, $event)">
        <b>{{ '_angularcore.claims.not-set' | translate }}</b>
        <p>{{ '_angularcore.claims.not-set-desc' | translate }}</p>
      </div>
      <div class="claim-person-detail"
        *ngIf="subClaim.active"
        [@growTransition]="{ value: ':enter', params : { height : '100px' } }">
        <div class="claim-detail-dates display-flex-justify">
          <div>
            <div class="display-flex-justify" text-center>
              <ion-icon name="add-circle"></ion-icon>
              <span *ngIf="subClaim.creationDate">
                {{ subClaim.creationDate | date:'mediumDate':'':translate.translate.currentLang }}
              </span>
              <span *ngIf="!subClaim.creationDate">
                ---
              </span>
            </div>
            <div class="display-flex-justify" text-center
              [class.danger]="subClaim.warnings.indexOf('expired') !== -1"
              *ngIf="subClaim.expirationDate">
              <ion-icon name="time"></ion-icon>
              <span>
                {{ subClaim.expirationDate | date:'mediumDate':'':translate.translate.currentLang }}
              </span>
            </div>
          </div>
        </div>

        <div class="detail-desc big-icon success" *ngIf="subClaim.warnings.length === 0">
          <ion-icon name="checkmark"></ion-icon>
        </div>

        <div class="detail-desc"
          [class.danger]="subClaim.warnings.indexOf('missing') !== -1"
          [class.warning]="subClaim.warnings.indexOf('missing') === -1"
          *ngIf="subClaim.warnings.length > 0">
          <ion-icon name="alert"></ion-icon>
          <span>
            {{ ('_angularcore.claims.warnings.' + subClaim.warnings[0]) | translate }}
          </span>
        </div>

        <ng-container
          *ngTemplateOutlet="claimInteraction;context:{ interactionClaim: subClaim }">
        </ng-container>
      </div>
    </div>
  </div>

  <!-- if a sub claim was clicked, show the next tree -->
  <div class="sub-claims-container" *ngIf="detailClaim.activeSubClaim"
    [@opacityTransition]>
    <ng-container
      *ngTemplateOutlet="claimDetailDisplay;context:{ detailClaim: detailClaim.activeSubClaim }">
    </ng-container>
  </div>
</ng-template>

<!--------------------------------------- usal component ------------------------------------------>
<ng-container *ngIf="!loading">
  <ng-container *ngIf="mode !== 'detail'">
    <ng-container *ngIf="compute">
      <ng-container
        *ngTemplateOutlet="claimDisplay;context:{ claim: computed, mode: mode }">
      </ng-container>
    </ng-container>
    <ng-container *ngIf="!compute">
      <ng-container *ngFor="let claim of claims">
        <ng-container
          *ngTemplateOutlet="claimDisplay;context:{ claim: claim, mode: mode }">
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>

  <div class="evan-detailed-claim" #evanDetailClaim *ngIf="mode === 'detail'">
    <ng-container col-12 col-xl-6 *ngIf="loadingClaims">
      <ng-container 
        *ngTemplateOutlet="claimDisplay;context:{ claim: computed, mode: mode }">
      </ng-container>
    </ng-container>
    <ng-container *ngIf="!loadingClaims">
      <ng-container
        *ngTemplateOutlet="claimDetailDisplay;context:{ detailClaim: computed }">
      </ng-container>
    </ng-container>
  </div>

  <div class="evan-modal evan-claim-modal"
    [class.show-modal]="!!popupClaim"
    [class.disable-scrolling]="disableScrolling">
    <div class="backdrop" (click)="closepopupClaim($event)"></div>

    <div class="evan-content evan-small-content"
      *ngIf="popupClaim">
      <h3 class="content-header m-b-0 m-t-0">
        {{ '_angularcore.claims.details' | translate }}
      </h3>
      <p ion-text class="m-b-0 m-t-0" *ngIf="!showAddressSelect">
        {{ '_angularcore.claims.details-desc' | translate }}
      </p>

      <ion-row>
        <ion-col margin-top col-12 col-md-6>
          <b>{{ '_angularcore.claims.topic' | translate }}</b>
          <p class="m-b-0 m-t-0">{{ popupClaim.name }}</p>
        </ion-col>
        <ion-col margin-top col-12 col-md-6>
          <b>{{ '_angularcore.claims.subject' | translate }}</b>
          <p class="m-b-0 m-t-0">
            <ng-container *ngIf="popupClaim.subjects">
              <ng-container *ngFor="let subject of popupClaim.subjects; let i = index">
                <span *ngIf="i !== 0">, </span>
                <ng-container *ngTemplateOutlet="userAlias;context:{ address:subject }"></ng-container>
              </ng-container>
            </ng-container>
            <ng-container *ngIf="!popupClaim.subjects">
              <ng-container *ngTemplateOutlet="userAlias;context:{ address:popupClaim.subject }"></ng-container>
            </ng-container>
          </p>
        </ion-col>
      </ion-row>

      <div class="evan-detailed-claim" #evanDetailClaim>
        <ng-container
          *ngTemplateOutlet="claimDetailDisplay;context:{ detailClaim: popupClaim }">
        </ng-container>
      </div>

      <div margin-top text-center>
        <button ion-button icon-left color="medium-gray" round outline
          (click)="closepopupClaim($event)">
          <ion-icon name="close" color="light"></ion-icon>
          <span color="light">{{ '_angularcore.claims.close-details' | translate }}</span>
        </button>
      </div>
    </div>
  </div>

  <div class="evan-modal"
    [class.show-modal]="!!issueClaim"
    [class.disable-scrolling]="disableScrolling">
    <div class="backdrop" (click)="this.issueClaim = null; ref.detectChanges()"></div>

    <div class="evan-content evan-small-content" *ngIf="issueClaim">
      <h2 class="content-header">{{ '_angularcore.claims.issue-claim' | translate }}</h2>

      <span
        [innerHTML]="'_angularcore.claims.issue-claim-description' | translate:{ topic: issueClaim.name, from: getAddressbookName(issueClaim.issuerAccount), to: getAddressbookName(issueClaim.subjects ? issueClaim.subjects[0] : issueClaim.subject) }">
      </span>

      <div class="display-flex-justify">
        <ion-checkbox margin-right
          [(ngModel)]="issueClaim.enableExpirationDate"
          (ionChange)="ref.detectChanges()"
          (focusout)="ref.detectChanges()">
        </ion-checkbox>
        <ion-item>
          <ion-label stacked>
            {{ '_angularcore.claims.expiration-date' | translate }}*
          </ion-label>
          <ion-datetime
            [disabled]="!issueClaim.enableExpirationDate"
            displayFormat="DD-MM-YYYY H:mm"
            pickerFormat="DD-MMM-YYYY HH:mm"
            [(ngModel)]="issueClaim.expirationDate"
            [placeholder]="'_angularcore.claims.expiration-date' | translate"
            [cancelText]="'_angularcore.claims.cancel' | translate"
            [doneText]="'_angularcore.claims.done' | translate"
            minuteValues="0,15,30,45"
            [min]="now"
            [max]="maxDate"
            [monthShortNames]="translate.monthShortNames"
            (ionChange)="ref.detectChanges()"
            (focusout)="ref.detectChanges()">
          </ion-datetime>
        </ion-item>
      </div>

      <div margin-top text-center>
        <button ion-button icon-left color="medium-gray" round outline
          (click)="this.issueClaim = null; ref.detectChanges()">
          <ion-icon name="close" color="light"></ion-icon>
          <span color="light">{{ '_angularcore.claims.close-details' | translate }}</span>
        </button>

        <button ion-button outline round icon-left
          [disabled]="computed.loading || (issueClaim.enableExpirationDate ? !issueClaim.expirationDate : false)"
          (click)="triggerDispatcher(issueClaim, 'issueDispatcher')">
          <ion-spinner *ngIf="computed.loading"></ion-spinner>
          {{ '_angularcore.claims.issue-claim' | translate }}
        </button>
      </div>
    </div>
  </div>
</ng-container>
